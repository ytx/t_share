---
- name: Deploy T-SHARE Application
  hosts: all
  become: yes
  vars_files:
    - "../secrets/{{ group_names[0] }}_secrets.yml"

  pre_tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

  tasks:
    # System Setup
    - name: Install required packages
      apt:
        name:
          - docker.io
          - docker-compose
          - git
          - curl
          - ufw
          - nginx
        state: present

    - name: Start and enable Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    # Create swap file early for build processes
    - name: Create swap file early
      block:
        - name: Check if swap exists
          command: swapon --show
          register: swap_check
          changed_when: false
          failed_when: false

        - name: Create 1GB swap file for builds
          shell: |
            dd if=/dev/zero of={{ swap_file_path }} bs=1M count=1024
            chmod 600 {{ swap_file_path }}
            mkswap {{ swap_file_path }}
            swapon {{ swap_file_path }}
            echo "{{ swap_file_path }} none swap sw 0 0" >> /etc/fstab
          when: swap_check.stdout == ""

    - name: Create application user
      user:
        name: "{{ app_user }}"
        system: yes
        shell: /bin/bash
        home: "{{ app_dir }}"
        groups: docker
        append: yes

    - name: Create application directory
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Create data directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
      loop:
        - "{{ data_dir }}"
        - "{{ ssl_cert_dir }}"

    # SSL Certificate Setup
    - name: Copy SSL certificates
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: '{{ item.mode }}'
      loop:
        - { src: "{{ ssl_cert_source_file }}", dest: "{{ ssl_cert_file }}", mode: '0644' }
        - { src: "{{ ssl_ca_source_file }}", dest: "{{ ssl_ca_file }}", mode: '0644' }
        - { src: "{{ ssl_key_source_file }}", dest: "{{ ssl_key_file }}", mode: '0600' }

    # Application Code
    - name: Remove existing application directory if it exists
      file:
        path: "{{ app_dir }}"
        state: absent

    - name: Clone application repository directly
      shell: |
        git clone {{ git_repo_url }} {{ app_dir }}
        cd {{ app_dir }}
        git checkout {{ git_branch }}
        chown -R {{ app_user }}:{{ app_group }} {{ app_dir }}

    # Production Environment Files
    - name: Generate production docker-compose file
      template:
        src: "../templates/docker-compose.prod.yml.j2"
        dest: "{{ app_dir }}/docker-compose.prod.yml"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'


    # Nginx Configuration
    - name: Generate Nginx configuration
      template:
        src: "../templates/nginx.conf.j2"
        dest: "/etc/nginx/sites-available/{{ app_name }}"
        owner: root
        group: root
        mode: '0644'

    - name: Enable Nginx site
      file:
        src: "/etc/nginx/sites-available/{{ app_name }}"
        dest: "/etc/nginx/sites-enabled/{{ app_name }}"
        state: link

    - name: Remove default Nginx site
      file:
        path: "/etc/nginx/sites-enabled/default"
        state: absent

    - name: Test Nginx configuration
      command: nginx -t
      changed_when: false

    - name: Start and enable Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes


    # Systemd Service
    - name: Generate systemd service file
      template:
        src: "../templates/systemd/t-share.service.j2"
        dest: "/etc/systemd/system/{{ app_name }}.service"
        owner: root
        group: root
        mode: '0644'
      notify:
        - reload systemd
        - restart application

    # Firewall Configuration
    - name: Configure UFW firewall
      block:
        - name: Allow OpenSSH
          ufw:
            rule: allow
            name: OpenSSH

        - name: Allow HTTP
          ufw:
            rule: allow
            port: '80'

        - name: Allow HTTPS
          ufw:
            rule: allow
            port: '443'

        - name: Enable UFW
          ufw:
            state: enabled
            policy: deny

    # Application Deployment
    - name: Clean up existing Docker resources
      shell: |
        cd {{ app_dir }}
        sudo -u {{ app_user }} docker-compose -f docker-compose.prod.yml down -v || true
        docker volume rm t-share_postgres_data || true
        docker system prune -f || true

    - name: Build and start application
      shell: |
        cd {{ app_dir }}
        sudo -u {{ app_user }} docker-compose -f docker-compose.prod.yml build --no-cache
        sudo -u {{ app_user }} docker-compose -f docker-compose.prod.yml up -d
      environment:
        DOCKER_BUILDKIT: 1
        NODE_OPTIONS: "--max-old-space-size=1536"

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart application
      systemd:
        name: "{{ app_name }}"
        state: restarted
        enabled: yes

  post_tasks:
    - name: Wait for application to be ready
      uri:
        url: "http://localhost:{{ backend_port }}/api/health"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 10

    - name: Display deployment status
      debug:
        msg: |
          üéâ T-SHARE deployment completed successfully!

          üåê Application URL: {{ app_url }}
          üìä Environment: {{ environment }}
          üîß Backend Health: {{ health_check.json.status if health_check.json is defined else 'OK' }}

          üì± Access your application at: {{ app_url }}
# 定型文管理・共有Webアプリ (Template Share)

## プロジェクト概要
定型文を管理・共有するためのWebアプリケーション。ユーザーが定型文を作成・編集・共有し、文書作成時に効率的に活用できるシステム。

## 技術スタック
- **フロントエンド**: React
- **バックエンド**: Node.js
- **データベース**: PostgreSQL
- **デプロイ**: AWS EC2（Docker）

## 開発・運用コマンド
```bash
# 開発環境起動
npm run dev

# ビルド
npm run build

# テスト実行
npm test

# リント・型チェック
npm run lint
npm run typecheck

# Dockerビルド
docker build -t template-share .

# Docker起動
docker-compose up -d
```

## プロジェクト構成
```
/
├── frontend/          # Reactアプリケーション
├── backend/           # Node.js API サーバー
├── database/          # PostgreSQL設定・マイグレーション
├── docs/              # ドキュメント
├── docker/            # Docker設定
└── README.md
```

## 主要機能
1. **認証・権限管理** - Googleログイン、管理者権限
2. **定型文管理** - 作成・編集・検索・履歴管理、タグ・シーン分類
3. **プロジェクト管理** - 作成・編集・削除、公開/非公開設定
4. **文書作成** - Aceエディタ、マークダウン、プレビュー
5. **変数管理** - ユーザ変数・プロジェクト変数
6. **設定管理** - エディタ設定
7. **管理機能** - ユーザー・タグ・シーン・プロジェクト・データ管理

## 開発ガイドライン
- コードスタイル: Prettier + ESLint
- コミットメッセージ: Conventional Commits
- ブランチ戦略: Git Flow
- テスト: Jest + React Testing Library

## 最新の変更履歴 (2025-09-19)

### ACEエディタテーマ設定の実装
1. **ライト・ダークモード個別テーマ設定**
   - エディタ設定にACEエディタのテーマ選択機能を追加
   - ライトモードとダークモードで異なるテーマを設定可能
   - 従来の単純なlight/darkテーマ切り替えを廃止
   - 豊富なACEテーマオプション（ライト7種類、ダーク16種類）

2. **バックエンドAPI拡張**
   - Prismaスキーマに `editorLightTheme`, `editorDarkTheme` フィールド追加
   - `UserPreferenceService` でACEテーマ設定の保存・取得機能実装
   - データベースマイグレーション対応
   - Zodバリデーションスキーマにテーマフィールド追加

3. **フロントエンド機能実装**
   - `EditorSettingsPanel` にACEテーマ選択UI追加
   - Material-UI Selectコンポーネントでテーマ選択
   - テーマモード（light/dark）に応じた自動テーマ切り替え
   - 全ACEテーマの動的インポート対応

4. **エディタ統合**
   - `MarkdownEditor` コンポーネントでACEテーマ適用
   - `DocumentEditor` でユーザー設定との連携
   - テーマ変更の即座反映
   - デバッグログによる状態監視

5. **技術的修正・バグフィックス**
   - Material-UI Select undefined値エラーの修正
   - API型定義とバックエンドスキーマの整合性確保
   - Zodバリデーションによるテーマフィールド認証問題の解決
   - フロントエンド・バックエンド間のデータフロー最適化

### データエクスポート・インポート機能の実装
1. **包括的データ管理システム**
   - 全システムデータのエクスポート機能（pretty formatのJSON）
   - エクスポートしたデータからの完全システム復元機能
   - 管理画面の「データ管理」タブに統合
   - 開発・運用初期での利用を想定

2. **バックエンドAPI実装**
   - `DataExportImportService` - データベース操作を処理
   - `dataExportImportController` - REST APIエンドポイント
   - `/api/admin/data/export` - 全データエクスポート
   - `/api/admin/data/import` - データインポート
   - `/api/admin/data/stats` - エクスポート統計
   - `/api/admin/data/validate` - インポートデータ検証

3. **フロントエンド機能**
   - `DataManagementPanel` - エクスポート・インポートUI
   - 統計情報表示（ユーザー・定型文・プロジェクト・文書件数）
   - ファイル検証機能（エラー・警告表示）
   - インポートオプション（既存データクリア・ID保持）
   - プログレス表示・エラーハンドリング

4. **データ処理の安全性**
   - トランザクション内での処理実行
   - 外部キー制約の適切な管理
   - 依存関係を考慮した順序処理
   - バリデーション・エラーハンドリング
   - 全12テーブルの完全対応

### プロジェクト管理システムの実装
1. **ユーザープロジェクト管理機能**
   - プロジェクトの作成・編集・削除機能
   - 公開/非公開設定（isPublicフラグ）
   - 設定画面内にプロジェクト管理タブを追加
   - 文書数による削除制限（文書がある場合は削除不可）
   - 日本語ローカライズ対応

2. **バックエンドAPI拡張**
   - Prismaスキーマに`isPublic`フィールド追加
   - プロジェクトサービス・コントローラーの更新
   - adminModeパラメータ対応（管理者は全プロジェクト表示）
   - アクセス制御ロジック実装

3. **管理画面プロジェクト管理**
   - 管理者用プロジェクト管理画面の実装
   - `adminMode: true`で全プロジェクト表示
   - 作成者情報・文書数・公開設定の表示
   - 管理者権限での編集・削除機能

### 定型文編集機能の強化
1. **タグ作成機能**
   - 定型文編集画面でのタグ作成機能追加
   - カラーピッカー対応（デフォルト: #1976d2）
   - 作成後の自動選択機能
   - エラーハンドリング・バリデーション

2. **UI/UX改善**
   - 既存タグ選択UIを維持しつつ作成機能を統合
   - シーン作成と同様のUI構成
   - フォーム表示・非表示の切り替え
   - 作成中ローディング状態表示

### 技術的修正・改善
1. **API実装**
   - RTK Query hooksの追加（useCreateTagMutation）
   - TemplateEditModal・TemplateCreateModalにタグ作成機能統合
   - 状態管理の最適化（作成フォーム状態・エラーハンドリング）

2. **データベース・バックエンド**
   - プロジェクトスキーマ更新（Prisma）
   - adminModeに応じたプロジェクト取得ロジック
   - アクセス制御とプライバシー設定

3. **フロントエンド改善**
   - コンポーネント間の状態管理統一
   - エラー表示とローディング状態の一貫性
   - Material-UIコンポーネントの活用

### 技術的修正・バグフィックス
1. **loggerインポート修正**
   - `dataExportImportController.ts` - default importに変更
   - `dataExportImportService.ts` - default importに変更
   - バックエンドエラー「Cannot read properties of undefined」の解決

2. **管理画面統合**
   - データ管理機能を設定画面から管理画面に移動
   - 管理者権限が必要な機能として適切に配置
   - UI/UX統一とアクセス制御の改善

### 以前の変更履歴 (2025-01-19)

### 管理画面機能の実装
1. **タグ管理システム**
   - タグの追加・編集・削除機能
   - タグのマージ機能（重複タグの統合）
   - 統計情報表示（使用回数・関連テンプレート数）
   - カラーパレット対応（事前定義色 + 自由入力）
   - タブ形式のUI（一覧・マージ・統計）

2. **シーン管理システム**
   - シーンの追加・編集・削除機能
   - シーンのマージ機能（重複シーンの統合）
   - 統計情報表示（関連テンプレート数・使用状況）
   - タグ管理と同様のUI構成

3. **管理ダッシュボード**
   - 「管理者ダッシュボード」→「管理画面」に変更
   - 統計カード表示を削除してコンパクト化
   - 上部スペースを圧縮（64px → 16px）
   - テーブルのスクロール機能追加
   - SplitPaneの視認性向上（カスタムCSS）

4. **ユーザー管理システム**
   - ユーザーの追加・編集・削除機能
   - 管理者権限の設定・変更
   - パスワードハッシュ化（bcrypt）
   - バリデーション（Zod）
   - 500エラー・404エラーの修正

5. **管理者機能強化**
   - 管理者モード切替スイッチ
   - 全定型文表示 vs 公開・自分の定型文のみ表示
   - SupervisorAccountアイコン表示
   - テンプレート検索でのadminModeパラメータ対応

### バックエンドAPI拡張
1. **管理者用CRUD API**
   - `POST /api/admin/users` - ユーザー作成
   - `PUT /api/admin/users/:id` - ユーザー更新
   - `DELETE /api/admin/users/:id` - ユーザー削除
   - Zodバリデーション・エラーハンドリング強化

2. **テンプレート検索拡張**
   - adminModeパラメータ追加
   - 管理者権限による表示制御
   - バリデーションスキーマ更新

3. **データベース修正**
   - Prismaスキーマフィールド名の修正
   - `templates` → `createdTemplates`
   - `projects` → `createdProjects`

### UI/UX改善
1. **検索インターフェースの整理**
   - 定型文検索のタイトルと新規作成ボタンを削除
   - キーワード検索とタグフィルターを統合し、折りたたみ可能に
   - 検索・フィルターボタンとクリアボタンをアイコンのみに変更
   - フィルター部分のパディング・マージンを調整してコンパクト化

2. **ステータス管理の簡素化**
   - 検索条件・編集画面からステータス項目を削除
   - 定型文作成時は自動的に公開状態に設定
   - 公開スイッチは「新しいシーンを作成」ボタンの右側に配置

3. **スクロール動作の最適化**
   - ページ全体のスクロールを無効化
   - 検索結果エリアとエディタ内部でのみスクロール可能
   - ヘッダを固定位置に設定（position: fixed）
   - SplitPaneとコンテンツ高さを適切に調整

4. **テンプレート表示の改善**
   - 非公開テンプレートに赤色の背景色を追加
   - テンプレートカードの内容を全表示（スクロール無効化）
   - カード内のpタグマージンを調整

5. **エディタ改善**
   - ACEエディタの配置を調整し、保存・コピーボタンとの重複を解消
   - エディタ内スクロールを有効化
   - ボタンエリアの影を削除してフラットデザインに統一

6. **ID属性の追加**
   - 主要なdiv要素にID属性を追加（デバッグ・特定の容易化）
   - dashboard-container、main-content、search-filters-header等

### 技術的修正
- バックエンドバリデーションでテンプレート更新時の空文字列を許可
- エディタ設定でスクロールバー表示オプションを追加
- レスポンシブ対応とレイアウト調整
- RTK Query mutations の実装
- 管理者認証・認可ミドルウェアの適用